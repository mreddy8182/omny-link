<section id="currentSect" style="display:none">
  <h2>
    <span>{{current.name}}</span>
    <div class="pull-right">
      {{#current.deploymentId}}
        {{#current.suspended}}
          <a class="glyphicon glyphicon-pause" aria-hidden="true" onclick="ractive.activate('{{current.key}}')" title="Activate"></a>
        {{else}}
          <a class="glyphicon glyphicon-play" aria-hidden="true" onclick="ractive.startInstance('{{current.key}}', '{{current.name}}', '{{username}}')" title="Start instance"></a>
          <a class="glyphicon glyphicon-pause" aria-hidden="true" onclick="ractive.suspend('{{current.key}}')" title="Suspend"></a>
        {{/}}
      {{/}}
      <a class="glyphicon glyphicon-cloud-download" href="{{context}}/{{tenant.id}}/process-definitions/{{current.id}}.bpmn" target="bpmn" title="Download the BPMN representation of the process"></a>
      {{#current.deploymentId}}
        <a class="clickable glyphicon glyphicon-remove" aria-hidden="true" onclick="ractive.delete({{current.deploymentId}})" title="Delete this definition"></a>
      {{/}}
      {{^current.deploymentId}}
        <a class="clickable glyphicon glyphicon-remove" aria-hidden="true" onclick="ractive.delete('{{current.id}}')" title="Delete this definition"></a>
      {{/}}
    </div>          
  </h2>
  <p>{{current.description}}</p>
  <table class="table">
    <thead>
      <tr>
        <th>Id</th>
        {{#current.category}}<th>Category</th>{{/}}
        <th>Deployed At</th>
        <th>Hash</th>
        <th>Deployment Id</th>
        {{#current.deployment.name}}<th>Deployment</th>{{/}}
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{current.id}}</td>
        {{#current.category}}<td>{{current.category}}</td>{{/}}
        {{#current.deployment.deploymentTime}}<td>{{formatDateTime(current.deployment.deploymentTime)}}</td>{{/}}
        <td>{{current.md5Hash}};</td>
        {{#current.deploymentId}}<td>{{current.deploymentId}}</td>{{else}}Incomplete model cannot be run{{/}}
        {{#current.deployment.name}}<td>{{current.deployment.name}}</td>{{/}}
      </tr>
    </tbody>
  </table>
  {{#current.messageNames}}
    <ul>
      <li><a href="{{context}}/{{tenant.id}}/messages/{{.}}.html">API for {{.}}</a></li>
    </ul>
  {{/}}
  {{#if current.id}}
    <div id="curImage">{{{current.image}}}</div>
    {{#if selectedBpmnObject}}
      <h3>
        <span>Properties</span>
      </h3>
      <table id="propertiesTable" style="width:100%">
        <thead>
          <tr>
            {{#if hasRole('admin') }}<th class="a-secondary-label control-label">Id</th>{{/if}}
            <th class="a-secondary-label control-label">Name</th>
            <th class="a-secondary-label control-label">Type</th>
            {{#selectedBpmnObject.calledElement}}<th class="a-secondary-label control-label">Calls</th>{{/}}
            {{#selectedBpmnObject.condition}}<th class="a-secondary-label control-label">Condition</th>{{/}}
            {{#selectedBpmnObject.resource}}<th class="a-secondary-label control-label">Resource</th>{{/}}
            {{#selectedBpmnObject.script}}<th class="a-secondary-label control-label">Script</th>{{/}}
            {{#selectedBpmnObject.serviceType}}<th class="a-secondary-label control-label">Service Type</th>{{/}}
            {{#selectedBpmnObject.timerCycle}}<th class="a-secondary-label control-label">Timer Cycle</th>{{/}}
            {{#selectedBpmnObject.timerDate}}<th class="a-secondary-label control-label">Timer Date</th>{{/}}
            {{#selectedBpmnObject.timerDuration}}<th class="a-secondary-label control-label">Timer Duration</th>{{/}}
            <!--th>Actions</th-->
          </tr>
        </thead>
        <tbody>
          <tr>
            {{#if hasRole('admin') }}<td class="col-md-1">{{selectedBpmnObject.id}}</td>{{/if}}
            <td class="col-md-1">{{#selectedBpmnObject.name}}{{selectedBpmnObject.name}}{{else}}n/a{{/}}</td>
            <td class="col-md-1">{{selectedBpmnObject.type}}</td>
            {{#selectedBpmnObject.calledElement}}<td class="col-md-1">{{selectedBpmnObject.calledElement}}</td>{{/}}
            {{#selectedBpmnObject.condition}}<td class="col-md-1">{{selectedBpmnObject.condition}}</td>{{/}}
            {{#selectedBpmnObject.resource}}<td class="col-md-1">{{selectedBpmnObject.resource}}</td>{{/}}
            {{#selectedBpmnObject.script}}<td class="col-md-4">{{selectedBpmnObject.script}}</td>{{/}}
            {{#selectedBpmnObject.serviceType}}<td class="col-md-1">{{selectedBpmnObject.serviceType}}</td>{{/}}
            {{#selectedBpmnObject.timerCycle}}<td class="col-md-1">{{selectedBpmnObject.timerCycle}}</td>{{/}}
            {{#selectedBpmnObject.timerDate}}<td class="col-md-1">{{selectedBpmnObject.timerDate}}</td>{{/}}
            {{#selectedBpmnObject.timerDuration}}<td class="col-md-1">{{selectedBpmnObject.timerDuration}}</td>{{/}}
            <!--td>&nbsp;</td-->
          </tr>
        </tbody>
      </table>
    {{/if}}
  {{/if current.id}}
  {{#current.deploymentId}}
    <h3>
      <span>Instances</span>
      <span class="pull-right">
	      <span class="clickable glyphicon glyphicon-refresh" aria-hidden="true" onclick="ractive.fetchInstances()" style="top: -15px;" title="Refresh instance list"></span>
	      <span class="clickable glyphicon glyphicon-remove" on-click="deleteSelectedInstances()" style="top: -15px;" title="Delete selected instances"></span>
	    </span>
    </h3>
    <table id="instancesTable" style="width:100%">
      <thead>
        <tr>
          {{#if hasRole('admin') }}
            <td><input class="checkbox" type="checkbox" onchange="$('#instancesTable>tbody>tr>td>.checkbox').click();"/></td>
          {{/if}}
          <th class="a-secondary-label control-label" on-click="sortInstances:businessKey">Name<span class="sortable {{ sortedInstance('businessKey') }} glyphicon"></th>
          {{#if hasRole('admin') }}<th on-click="sortInstances:id">Id<span class="sortable {{ sorted('id') }} glyphicon"></th>{{/if}}
          <th class="a-secondary-label control-label" on-click="sortInstances:startTime">Started<span class="sortable {{ sortedInstance('startTime') }} glyphicon"></th>
          <th class="a-secondary-label control-label" on-click="sortInstances:endTime">Completed<span class="sortable {{ sortedInstance('endTime') }} glyphicon"></th>
          {{#if .!=undefined && !..ended}}
	          <th class="a-secondary-label control-label" on-click="sortInstances:activityId">Current task<span class="sortable {{ sortedInstance('activityId') }} glyphicon"></th>
	        {{/if}}
	        <th>Actions</th>
        </tr>
      </thead>
		    {{#each sort(current.instances,sortInstanceColumn,sortInstanceAsc):i}}
		      <tbody>
		        <tr data-instance-id="{{id}}">
		          {{#if hasRole('admin') }}
                <td><input class="checkbox" type="checkbox" checked="{{..selected}}"/></td>
              {{/if}}
			        <td>
			          {{#businessKey}} {{businessKey}} {{else}} N/A {{/}}
			        </td>
			        {{#if hasRole('admin') }}<td>{{id}}&nbsp;</td>{{/if}}
			        <td class="a-secondary-data">{{formatDateTime(startTime)}}</td>
			        <td class="a-secondary-data">{{ended ? formatDateTime(endTime) : 'n/a'}}</td>
			        {{#if .!=undefined && !..ended && activityId!=undefined}}
			          <td class="a-secondary-data">{{activityId.toLabel()}}</td>
			        {{else}}
			          <td>None</td>
			        {{/if}}
			        <td>
			          <span class="clickable glyphicon glyphicon-eye-open" on-click="toggleAuditTrail(this,i)"></span>
			          <span class="clickable glyphicon glyphicon-remove" on-click="deleteInstance(this,i)"></span>
			        </td>
			      </tr>
			      <tr>
			        <td colspan="7">
				        <section class="instanceSect" data-instance-id="{{id}}" style="clear:both;display:none">
				          <h4> {{#businessKey}} Instance {{id}} {{else}} {{businessKey}} ({{id}}) }}{{/}}</h4>
				          <h5>History</h5> 
				          <table class="table table-striped">
				            <thead>
				              <tr>
				                <th></th>
				                <th>Type</th>
				                <th class="col-truncate">Event</th>
				                <th>Started</th>
				                <th>Ended</th>
				                <th>Duration</th>
				                <th>Actioned by</th>
				              </tr>
				            </thead>
				            <tbody>
				              {{#each auditTrail:j}}
				                <tr data-href="{{_links.self.href}}">
				                  <td>{{j+1}}</td>
				                  <td><span class="{{renderBpmnIcon(activityType)}}" style="font-size:24px"></span></td>
				                  <td>{{activityName}}</td>
				                  <td>{{formatDateTime(startTime)}}</td>
				                  <td>{{formatDateTime(endTime)}}</td>
				                  <td>{{endTime == undefined ? '' : duration(durationInMillis)}}</td>
				                  <td>
				                    {{#allocations}}
				                      {{#type=='candidate'}}Offered to:{{/}} {{groupId}}{{userId}}<br/>
				                    {{/}}
				                  </td>
				                </tr>
				              {{/each}}
				            </tbody>
				          </table>
				          <h5>Latest Data</h5>
				          <table class="table table-striped">
				            <thead>
				              <tr>
				                <th></th>
				                <th class="col-truncate">Name</th>
				                <th>Value</th>
				              </tr>
				            </thead>
				            <tbody>
				              {{#each processVariableNames:j}}
				                <tr data-href="{{_links.self.href}}">
				                  <td>{{j+1}}</td>
				                  <td>{{ processVariableNames[j] }}</td>
				                  <td>
				                    {{# typeof processVariables[processVariableNames[j]] == 'object' }}
				                      {{{ formatJson(JSON.stringify(processVariables[processVariableNames[j]])) }}}
				                    {{else}}
				                      {{{ processVariables[processVariableNames[j]] }}}
				                    {{/}}
				                  </td>
				                </tr>
				              {{/each}}
				            </tbody>
				          </table> 
			          </section>
			        </td>
			      </tr>
			    </tbody>
		    {{/each}}
	    <tfoot>
	      <tr><th colspan="5">Total of {{current.instances.length}} instances</th></tr>
	    </tfoot>
    </table>
  {{/}}
  {{^current.deploymentId}}
    <section style="margin-bottom: 2px;">
      <span class="glyphicon glyphicon-warning-sign pull-right" on-click="showIssues()" style="position:relative;top:-12px;"></span>
      <h3>Items to be completed</h3>
      <p>To be eligible for execution these parts of the model need to be completed.</p>
      <table>
        <thead></thead>
        <tbody>
          {{#current.issues:i}}
            <tr>
              <td><a href="#{{modelRef}}">{{i+1}}</a></td>
              <!-- <td class="col-md-1">{{level}}</td> -->
              <td>{{description}}</td>
            </tr>
          {{/}}
        </tbody>
      </table>
    </section><!-- /List of items to complete -->
  {{/}}
</section>
