<!doctype html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8'>
  <title>Work Management</title>
  <link href="/webjars/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
  <link href="/webjars/bootstrap/3.3.5/css/bootstrap-theme.min.css" rel="stylesheet">
  <link href="css/omny-1.0.0.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/icon/omny-icon-16x16.png" />
</head>
<body>
  <div class="clearfix" id="messages"></div>
  <div class="container" id="container"></div>
  <script id='template' type='text/ractive'>
    {{>profileArea}}
    {{>titleArea}}
  
    <form id="taskList">
      <section id="taskSect">
        <h2>
          <a id="tasksTableToggle" class="clickable glyphicon glyphicon-triangle-bottom" aria-hidden="true" on-click="toggleResults()" title="Collapse or expand the task table"></a>
          <span>Tasks</span>
          <a class="clickable glyphicon glyphicon-envelope admin" aria-hidden="true" on-click="newMessage()" title="Send a new message"></a>
          <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetch()" title="Refresh the list"></a>
          <input type="search" class="form-control search" placeholder="Search" value="{{searchTerm}}">
          <a class="glyphicon glyphicon-search" aria-hidden="true" title="Search for matching contacts"></a>
          <a class="clickable dropdown" aria-hidden="true" title="Show filters">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                <a class="clickable glyphicon glyphicon-filter dropdown" aria-hidden="true" title="Show filters"> <span class="caret"></a>
              </a>
              <ul class="omny-dropdown dropdown-menu" role="menu">
                <li on-click="filter()">Clear filter</li>
                <li class="divider"></li>
                <li onclick="ractive.filter('deferred')">Hide Deferred Tasks</li>
              </ul>
          </a>
          <!--
            <span class="clickable dropdown" aria-hidden="true" title="Start Process">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                    <a class="clickable glyphicon glyphicon-play dropdown" aria-hidden="true" title="Start Process"> <span class="caret"></a>
                  </a>
                  <ul class="omny-dropdown dropdown-menu" role="menu">
                    {{#each tenant.customerActions }}
                      <li onclick="ractive.startCustomerAction('{{key}}', '{{label}}', ractive.get('current'))">{{label}}</li>
                    {{/each}}
                  </ul>
                </span>
          -->
        </h2>
        <div id="sendMessage" style="display:none">
          <form action="/msg/{{tenant.id}}/" class="well form" id="sendMessageForm" method="post">
              <fieldset>
                <div class="form-group">
                  <label class="" for="messageName">Message Name</label>
                  <input class="form-control" name="tenantId" id="tenantId" type="hidden" value="{{message.tenantId}}"/>
                  <input class="form-control" name="messageName" id="messageName" placeholder="{{tenant.id}}.message" value="{{message.name}}"/>
                </div>
                <div class="form-group">
                  <label class="" for="messagePattern">Message Exchange Pattern</label>
                  <label class="radio"><input class="" name="{{message.pattern}}" type="radio" value="inOut"> In-Out</label>
                  <label class="radio"><input class="" name="{{message.pattern}}" type="radio" checked="checked" value="inOnly"> In-Only</label>
                </div>
                <div class="form-group">
                  <label for="bizKey">Business Identifier</label>
                  <input class="form-control" name="bizKey" id="bizKey" placeholder="" value="{{message.bizKey}}"/>
                </div>
                <div class="form-group">
                  <label class="textarea" for="messageBody" style="width: 35%;">Message</label>
                  <textarea class="form-control" name="messageBody" id="messageBody" placeholder="Message payload (JSON)" style="width:60%;display: inline-block;" value="{{message.body}}"></textarea>
                </div>
                <div class="form-group pull-right">
                  <button class="btn btn-default" on-click="collapseSendMessage()" type="button">Cancel</button>
                  <button class="btn btn-primary" on-click="sendMessage()" type="button">Send message</button>
                </div>
              </fieldset>
            </form>
        </div>
        <table id="tasksTable" class="table table-striped">
          <thead>
            <tr>
              <th></th>
              <th>From / Regarding</th>
              <th class="col-truncate">Task</th>
              <th>Created</th>
              <th>Due</th>
              <!--th class="col-truncate" style="width: 400px;">Description</th-->
              <th>Assigned</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
<!--
searchTerm!=undefined && (
                  (this.name!=undefined && this.name.toLowerCase().indexOf(searchTerm.toLowerCase()))===0 
                  || (this.businessKey!=undefined && this.businessKey.toLowerCase().indexOf(searchTerm.toLowerCase()))===0
-->
          {{#each tasks:i}}
            {{# matchFilter(this) }}
            <tr data-href="{{_links.self.href}}">
              <td on-click="edit(this)">{{i+1}}</td>
              <td on-click="edit(this)">{{businessKey}}</td>
              <td on-click="edit(this)">{{name == null ? taskDefinitionKey.toLabel() : name}}</td>
              <td on-click="edit(this)">{{formatDate(createTime)}}</td>
              <td on-click="edit(this)">{{formatDate(dueDate)}}</td>
              <!--td on-click="edit(this)">{{description}}</td-->
              <td on-click="edit(this)">{{assignee==null ? 'No' : 'Yes'}}</td>
              <td>
                <a class="clickable glyphicon glyphicon-pencil" aria-hidden="true" on-click="edit(this)"></a>
              </td>
            </tr>
            {{/}}
          {{/each}}
          </tbody>
        </table>
      </section>

      <section id="currentSect" style="display:none">
        <h2>
          <span>{{current.businessKey}}: {{current.name == null ? current.taskDefinitionKey.toLabel() : current.name}}</span> 
          <span class="admin">({{current.id}})</span>
        </h2>

        <form id="currentForm">
          {{#current.description}}
            <p class="col-md-12 bg-info text-info">{{current.description}}</p>          
          {{/}}
          <div class="col-md-6">
            <ul class="form edit-form">
              <li><label class="col-md-5">Due:</label><input class="nodatepicker form-control" id="curDueDate" on-blur="save()" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" placeholder="dd/mm/yyyy" value="{{formatDate(current.dueDate)}}"></li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="form edit-form">
              <li><label class="col-md-5">Started By:</label><input class="form-control" id="curInitiator" disabled readonly value="{{current.processVariables['initiator']=='anonymousUser' ? 'Web Site' : current.processVariables['initiator']}}"></li>
              <li><label class="col-md-5">Created:</label><input class="form-control" id="curCreated" disabled readonly value="{{formatDate(current.createTime)}}"></li>
            </ul>
          </div>
        
          {{#current.formKey!=undefined}}
            {{>userForm { current: current } }}
          {{/}}
          {{#current.formKey==undefined && current.formProperties.length>0}}
            {{>userForm { current: current } }}
          {{/}}
        </form>

        <button class="btn btn-warning" on-click="deferTask()" type="button">Remind Me Tomorrow</button>
        <div class="pull-right">
          <button class="btn btn-success" on-click="submitCompleteTask()" type="button">Complete Task</button>
          <button class="btn btn-danger" data-process-instance-id="{{current.processInstanceId}}" on-click="submitColdTask()" type="button">Set to Cold</button>
        </div>
      </section>

    </form>
    {{>poweredBy}}
    {{>sidebar { active: 'work.html' }}}
  </script>

  <script id="enumTemplate" type="text/html">
    <label class="col-md-offset-3">{{name}}</label>
    <select id="{{..id}}" {{..writeable==false ? 'readonly disabled' : ''}} onblur="ractive.get('current').processVariables[this.id]=this.value" value="{{..value}}">
      <option></option>  
    </select>
  </script>
  <script id="jsonTemplate" type="text/html">
    <fieldset><legend class="col-md-12">{{name}}</legend>
<div class="clearfix"></div>
<ul>
  {{# keys}}
    <li>
      <label class="col-md-3">{{.}}</label>
      <input class="form-control" id="cur{{.}}" readonly value="{{obj[.]}}">
    </li>
  {{/}}
</ul>
    </fieldset>
  </script>
  <script id="linkTemplate" type="text/html">
    <!-- TODO need to get this from tenant config -->
    <a class="col-md-offset-3" href="{{value}}" target="_newtab">{{name == undefined ? id : name}}</a>
  </script>
  <script id="defaultTemplate" type="text/html">
    <label class="col-md-3">{{name}}</label>
    <input id="{{..id}}" {{..writeable==false ? 'readonly disabled' : ''}} onblur="ractive.get('current').processVariables[this.id]=this.value" value="{{..value}}">
  </script>

  <script src="/webjars/jquery/1.11.1/jquery.min.js"></script>
  <script src="/webjars/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="/webjars/bootstrap-datepicker/1.4.0/js/bootstrap-datepicker.min.js"></script>
  <script src="/webjars/Bootstrap-3-Typeahead/3.1.1/bootstrap3-typeahead.js"></script>
  <script src="/webjars/ractive/0.7.1/ractive.min.js"></script>

  <script src="js/autoNumeric.js"></script>
  <script src="js/md5.min.js"></script>
  <script src="js/string-functions-0.1.0.js"></script>
  <script src="js/login-1.0.0.js"></script>
  <script src="js/workmgmt-1.0.0.js"></script>
  <script src="js/omny-1.0.0.js"></script>
</body>
</html>
